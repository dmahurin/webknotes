#!/usr/bin/perl

my($user);
if($<)
{
   $user = getpwuid($<)
}
else
{
   $user = "root";
}

my ($default_doc_root, $default_cgi_root, $default_cgi_alias,
   $user_dir) =
   &chomp_slashs(parse_httpd());
my $root_alias;
   
print "\nThese first few question are general questions about your web server setup\n\n";
$default = ($< && $user ne "www") ? "u" : "r";
   
if(prompt_default("Install in web Root or User directory", $default, "(r|u)") eq "r")
{
   $default_doc_root = "/home/httpd/html"
      unless(defined($default_doc_root));
   $default_cgi_root = "/home/httpd/cgi-bin"
      unless(defined($default_cgi_root));
   $default_cgi_alias = "/cgi-bin"
      unless(defined($default_cgi_alias));
   $doc_root_alias = "/";
   $default_private_web_dir = "/home/httpd/private";
}
else
{
   if(defined($user_dir))
   {
      $default_doc_root = "$ENV{\"HOME\"}/$user_dir";
   }
   else
   {
      $default_doc_root = "$ENV{\"HOME\"}/public_html";
   }
   undef $default_cgi_root;
   undef $default_cgi_alias;
   $doc_root_alias = "/~$ENV{\"USER\"}";
   $default_private_web_dir = "$ENV{\"HOME\"}/web_private";
}

$webknotes_base = ( $0 =~ m:/[^/]*$: ) ?  $` : ".";

$public_html_dir= prompt_default("Public html directory", $default_doc_root);
unless(-d $public_html_dir)
{
   print "Public html directory does not exist\n";
   exit(0);
}
if($public_html_dir =~ m:$default_doc_root/:)
{
   $doc_root_alias = '/' . $';
}
$public_html_wpath=prompt_default("Public html url path", $doc_root_alias);

$public_cgi_dir= prompt_default("cgi-bin directory", ($default_cgi_root || "$public_html_dir/cgi-bin"));
if(!defined($default_cgi_alias))
{
   $default_cgi_alias =   ($public_cgi_dir =~ ( m:^$public_html_dir/: )? "$public_html_wpath/$'" : 
   "$public_html_wpath/cgi-bin");
}
elsif($public_cgi_dir =~  m:^${default_cgi_root}/:)
{
   $default_cgi_alias =   "$default_cgi_alias/$'";
}

$public_cgi_wpath= prompt_default("cgi-bin url path", $default_cgi_alias);
$private_web_dir= prompt_default("Private web data directory", $default_private_web_dir);
unless(-d $private_web_dir)
{
   if(mkdir($private_web_dir,0755))
   {
      mkdir("$private_web_dir/groups",0755);
      mkdir("$private_web_dir/users",0755);
      mkdir("$private_web_dir/sessions",0755);
   }
   else
   {
      print "Error making directory: $private_web_dir\n";
   }
}

print "\nThe questions that follow allow changing the default webknotes sub paths\n\n";
$doc_sub_path = prompt_default("Document sub path ( '/' for toplevel)", "notes");
$doc_sub_path = "" if ($doc_sub_path eq '/');
$doc_dir = "$public_html_dir/$doc_sub_path";
$doc_wpath = "$public_html_wpath/$doc_sub_path";

if( ! -d $doc_dir )
{
   if(prompt_default("Create directory", "y", "(y|n)") eq "y")
   {
      print "Error creating director\n" unless(mkdir($doc_dir,0755));
      if(prompt_default("Copy sample notes", "y", "(y|n)") eq "y")
      {
	 system("cp -r '$webknotes_base/example/public/notes'/* $doc_dir");
      }
   }
}

$icons_sub_path = prompt_default("Icons sub path", "icons");
$icons_dir = "$public_html_dir/icons";
$icons_wpath = "$public_html_wpath/icons";

   

if( ! -d $icons_dir )
{
   if(prompt_default("Create icons directory", "y", "(y|n)") eq "y")
   {
      print "Error creating director\n" unless(mkdir($icons_dir,0755));
      if(prompt_default("Copy sample icons", "y", "(y|n)") eq "y")
      {
	 system("cp -r '$webknotes_base/example/public/icons'/* $icons_dir");
      }
   }
}

$cgi_subpath = prompt_default("cgi-bin webknotes subpath", "wkn");

   mkdir("$public_cgi_dir", 0755);
   mkdir("$public_cgi_dir/$cgi_subpath", 0755);

#$default = ( -d "$public_cgi_dir/$cgi_subpath" ) ? "n" : "y";
if(prompt_default("Copy webknotes cgi-bin", "y", "(y|n)") eq "y")
{
   system("cp -r $webknotes_base/cgi-bin/* $public_cgi_dir/$cgi_subpath");

   if(prompt_default("Set Setuid on scripts", "y", "(y|n)") eq "y")
   {
      system("chmod a+x,u+s $public_cgi_dir/$cgi_subpath/*.cgi");
   }
}


$default = ( -f "$public_cgi_dir/$cgi_subpath/auth_define.pl" ) ? "n" : "y";

if(prompt_default("Create configuration files", $default, "(y|n)") eq "y")
{
   
   
   unlink("$public_cgi_dir/$cgi_subpath/auth_define.pl");
   if(open(FILE, ">$public_cgi_dir/$cgi_subpath/auth_define.pl"))
   {
      print FILE
"#!/usr/bin/perl

package auth::define;

\$private_dir = \"$private_web_dir\";
\$doc_dir = \"$doc_dir\";
\$doc_wpath = \"$doc_wpath\";

\$path_permissions = { \"\" => \"+rn\"};

1;
";
      close FILE;
   }
   
   $admin_user = $< ? getpwuid($<) : "admin";
   $default = ( -f "$private_web_dir/users/$admin_user" ) ? "n" : "y";
   if(prompt_default("Create Admin login as '$admin_user'", $default, "(y|n)") eq "y")
   {
      while(1)
      {
         system "stty -echo";
         $admin_password = prompt_default("Admin Password", "");
         print "\n";
         $admin_password_check = prompt_default("Admin Password (verify)", "");
         print "\n";
         system "stty echo";
         if($admin_password ne $admin_password_check)
         {
            print "Passwords did not match. Try again\n";
         }
         else { last };
      }
      push(@INC, "$public_cgi_dir/$cgi_subpath");
      require "auth_lib.pl";
      if(! auth::write_user_info($admin_user,
         { "PassKey"=>auth::pcrypt1($admin_password),
         "AuthPath"=>'/',
         "Permissions"=>'rncmds',
         "Name"=>"Admin"}))
      {
         print "Error creating admin.\n";
      }
   }

   unlink("$public_cgi_dir/$cgi_subpath/wkn_define.pl");
   if(open(FILE, ">$public_cgi_dir/$cgi_subpath/wkn_define.pl"))
   {
      print FILE
"package wkn::define;
\$icons_wpath = \"$icons_wpath\";" , 
'
$default_layout = "table";
$default_theme = "don";
$frames_mode = "table";

$max_depth = 3;

$opened_icon = "fminus.gif";
$opened_icon_text = "[-]";
$closed_icon = "fplus.gif";
$closed_icon_text = "[+]";
$dir_icon = "folder.gif";
$dir_icon_text = "[+]";
$file_icon = "document.gif";
$file_icon_text = "[.]";
';
      close FILE;
   }
}


sub prompt_default
{
   my($prompt, $default, $choices) = @_;
      
   print "$prompt $choices [$default]: ";
   $line = <STDIN>;
   chomp($line);
   $line = $default if($line eq "");
   
   return $line;
}


sub parse_httpd
{

   my($line, $doc_root, $script_root, $script_alias, $user_dir);
   
   for $conf ( "/etc/httpd/conf/httpd.conf", "/etc/httpd/conf/srm.conf" )
   {
      next unless(open( HCONF, $conf));
      while(defined($line = <HCONF>))
      {
         if($line =~ m:^\s*DocumentRoot\s+:)
         {
            ($doc_root) = split_args($');
         }
         if($line =~ m:^\s*ScriptAlias\s+:)
         {
            ($script_alias, $script_root) = split_args($');
         }
         if($line =~ m:^\s*UserDir\s+:)
         {
            ($user_dir) = split_args($');
         }
      }
      close(HCONF);
   }
   if(!defined($doc_root))
   {                             
      print "Warning: http configuration not found";
   }
   return ($doc_root, $script_root, $script_alias, $user_dir);
}

sub split_args
{
   my($line) = @_;
   my(@args) = ();
   while($line =~ m:^\s*\"([^\"]*)\"|([^\"\s]+)\s*:)
   {
      push(@args, $1) if(defined($1));
      push(@args, $1) if(defined($2));
      $line = $';
   }
   return (@args);
}

sub chomp_slashs
{
   my(@paths);
   foreach(@_)
   {
      $_ =~ s:/+$::;
      push( @paths, $_);
   }
   return(@paths);
}
